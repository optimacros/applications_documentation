# Веб-интерфейсы<a name="web-handlers"></a>

1. [Создание веб-интерфейсов](#creation)
1. [Асинхронные функции](#async)
1. [Настройка приложения](#settings)
1. [Обращение к веб-интерфейсам](#request)
1. [Статические файлы](#static-files)

&nbsp;

## Создание веб-интерфейсов<a name="creation"></a>

```js
OM.web(eventName: string, [async] callback: (request: OMWebRequest) => string | WebHandlerResponse): void
```

Создает веб-обработчик с именем `eventName` для взаимодействия с другими приложениями, при обращении к которому будет выполняться функция `callback()`.

***В теле функции `callback()` не работают синхронные функции доступа к данным.*** Для взаимодействия с моделью необходимо пользоваться [`асинхронными функциями`](#async). С этой целью рекомендуется саму функцию `callback()` тоже объявлять асинхронной, хотя это и необязательно.

Входной параметр `request` содержит ссылку на интерфейс `OMWebRequest`.

### Интерфейс OMWebRequest

```ts
interface OMWebRequest {
    method: string,
    headers: { [x: string]: string },
    contentType: string,
    params: {
        appId: string,
        path: string,
    },
    urlRegex?: string[],
    query?: { [x: string]: string },
    body: { [x: string]: string },
}
```

Содержит информацию о запросе, который был передан веб-обработчику.

- `method` - [`метод HTTP-запроса`](https://ru.wikipedia.org/wiki/HTTP#%D0%9C%D0%B5%D1%82%D0%BE%D0%B4%D1%8B).
- `headers` - [`заголовки HTTP`](https://ru.wikipedia.org/wiki/Список_заголовков_HTTP).
- `contentType` - тип переданного контента [`Content-Type`](https://developer.mozilla.org/ru/docs/Web/HTTP/Headers/Content-Type).
- `params` содержит идентификатор приложения `appId` и URL-путь `path`, по которому был отправлен запрос к веб-обработчику.
- `urlRegex` - список групп совпадений адреса в регулярном выражении, если оно было задано, иначе это свойство отсутствует.
- `query` - параметры URL.
- `body` - тело запроса.

&nbsp;

Функция-обработчик возвращает ответ в формате строки или ссылку на интерфейс `WebHandlerResponse`. 

### Интерфейс WebHandlerResponse
```ts
interface WebHandlerResponse {
    headers: { [x: string]: string };
    body: string;
}
```

Содержит заголовки `headers` и тело ответа `body` в формате строки.

&nbsp;

В функциях веб-обработчиков нельзя устанавливать соединение с моделью через [`OM.connect()`](./API.md#model-connect), можно только выполнять асинхронную операцию соединения [`OM.connectAsync()`](./API.md#connect-async).

&nbsp;

## Асинхронные функции<a name="async"></a>

В Application Manager API некоторые функции имеют асинхронные аналоги. Имя асинхронного аналога функции `doSomething()` образовано из её имени и суффикса `'Async'`: `doSomethingAsync()`.

Каждая асинхронная функция принимает те же аргументы, что и её аналог, делает то же самое, что и аналог, и возвращает [`Promise`](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise), возвращающий то же самое значение, что и функция-аналог.

То есть, сигнатуры функций-аналогов выглядят так:

```js
doSomething( [args] ): result;
async doSomethingAsync( [args] ): Promise<result>;
```

Для вызова асинхронных функций можно использовать функционал класса [`Promise`](https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise) или синтаксис [`async/await`](https://learn.javascript.ru/async-await).

&nbsp;

## Настройка приложения<a name="settings"></a>

В настройках приложения в диалоговом окне `Edit Application` на вкладке `Executable Scripts` для исполняемого скрипта можно добавить список сопоставлений URL-адресов и веб-обработчиков, созданных в этом скрипте. Один веб-обработчик может иметь любое количество адресов. При обращении по такому адресу будет происходить вызов функции соответствующего веб-обработчика.

Сопоставления URL-адресов и веб-обработчиков задаются списком в свойстве `webHandlers`. Каждое такое сопоставление описывается с помощью следующих свойств:
- `handler` - название веб-обработчика, которое указано при его создании в функции [`OM.web()`](#creation).
- `url` - URL-адрес обращения к веб-обработчику. 

URL-адреса могут быть заданы с помощью [регулярного выражения](https://ru.wikipedia.org/wiki/Регулярные_выражения). В этом случае вместо свойства `url` нужно указать свойство `urlRegex`, значением которого является регулярное выражение.

### Пример

1. Создать веб-обработчик с помощью функции [`OM.web()`](#creation).
2. Сделать скрипт **исполняемым**.

![Web-Handler script](./pic/webHandlerScript.png)

3. Добавить список сопоставлений URL-адресов и веб-обработчиков в настройках приложения.

![Executable scripts](./pic/executableScripts.png)

&nbsp;

## Обращение к веб-интерфейсам<a name="request"></a>

Сторонее приложение может обращаться к веб-интерфейсам с помощью HTTP-запросов. При обращении к ресурсу сначала происходит поиск подходящего веб-обработчика в скриптах приложения. Если обработчик не найден - поиск [статического файла](#static-files) с совпадающим путем.

[`URL-адрес`](https://ru.wikipedia.org/wiki/URL) обращения к веб-интерфейсу формируется следующим образом:

`<схема>://<хост>/app/<ID приложения>/<URL‐путь>[?<параметры>]`, где
- `<схема>` - схема обращения к ресурсу; в большинстве случаев имеется в виду [сетевой протокол](https://ru.wikipedia.org/wiki/Протокол_передачи_данных),
- `<хост>` - полностью прописанное доменное имя хоста в системе DNS или IP-адрес хоста, на котором находится система Application Manager,
- `<ID приложения>` - идентификатор приложения,
- `<URL-путь>` - адрес обращения к веб-обработчику, заданый в настройках приложения,
- `<параметры>` - строка запроса с передаваемыми на сервер (методом GET) параметрами. Начинается с символа ?, разделитель параметров — знак &. Пример: `?параметр_1=значение_1&параметр_2=значение_2&параметр3=значение_3`.

### Пример

1. Формируем URL-адрес обращения к веб-обработчику из примера выше.
- Система Application Manager находиться на сервере по адресу `am08.optimacros.com`.
- Идентификатор приложения можно узнать в диалоговом окне `Edit Application`->`Application Info`.

![Application Info](./pic/applicationInfo.png)

Или из адресной строки в браузере.

![Application ID](./pic/appId.png)

- Веб-обработчик реагирует на адрес `hello.txt` и принимает входной параметр `name`.

Получаем URL-адрес обращения к веб-обработчику

`https://am08.optimacros.com/app/8940fd1a-a4ee-4f56-8533-513f12163555/hello.txt?name=Ivan%20Ivanov`

2. Отправляем HTTP-запрос из адресной строки в браузере и получаем результат выполнения.

![Web-handler result](./pic/webHandlerResult.png)

&nbsp;

## Статические файлы<a name="static-files"></a>

В настройках приложения в диалоговом окне `Edit Application` на вкладке `Web` можно указать папку, все файлы которой будут передаваться стороннему приложению в исходном виде.

### Пример

В приложении есть папка `staticWeb` со статическими файлами.

![Static Files](./pic/staticFiles.png)

Например, статический файл `index.html` будет доступен по адресу 

`https://am08.optimacros.com/app/8940fd1a-a4ee-4f56-8533-513f1216355/index.html`

&nbsp;

[API Reference](API.md)

[Оглавление](../README.md)
